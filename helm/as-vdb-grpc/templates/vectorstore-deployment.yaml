{{- if .Values.vectorstore.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "as-vdb-grpc.fullname" . }}-vectorstore
  namespace: {{ include "as-vdb-grpc.namespace" . }}
  labels:
    {{- include "as-vdb-grpc.labels" . | nindent 4 }}
    app.kubernetes.io/component: vectorstore
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "as-vdb-grpc.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: vectorstore
  template:
    metadata:
      labels:
        {{- include "as-vdb-grpc.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: vectorstore
    spec:
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "as-vdb-grpc.serviceAccountName" . }}
      initContainers:
        - name: wait-for-ftlserver
          image: busybox:1.35
          command: ['sh', '-c']
          args:
            - |
              echo "Waiting for FTL server to be ready..."
              until nc -z {{ include "as-vdb-grpc.fullname" . }}-ftlserver {{ .Values.ftlserver.service.port }}; do
                echo "FTL server not ready, sleeping..."
                sleep 5
              done
              echo "FTL server is ready!"
        # - name: wait-for-config
        #   image: busybox:1.35
        #   command: ['sh', '-c']
        #   args:
        #     - |
        #       echo "Waiting for config service to complete..."
        #       # Add logic to wait for config service completion
        #       sleep 30
      containers:
        - name: vectorstore
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: {{ include "as-vdb-grpc.imageRepository" (dict "root" . "image" .Values.vectorstore.image) }}:{{ include "as-vdb-grpc.imageTag" (dict "tag" .Values.vectorstore.image.tag "defaultTag" .Values.global.grpcServicesVersion) }}
          imagePullPolicy: {{ .Values.vectorstore.image.pullPolicy }}
          ports:
            - name: grpc
              containerPort: {{ .Values.vectorstore.service.targetPort }}
              protocol: TCP
          env:
            - name: AS_CONN_URL
              value: http://{{ include "as-vdb-grpc.fullname" . }}-ftlserver:{{ .Values.ftlserver.service.port }}
          resources:
            {{- toYaml .Values.vectorstore.resources | nindent 12 }}
          livenessProbe:
            tcpSocket:
              port: grpc
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: grpc
            initialDelaySeconds: 5
            periodSeconds: 5
      restartPolicy: Always
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}